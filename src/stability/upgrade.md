## 升级对API停服时间减少

---


### UnitedStack知识库文章

 - [数据库升级](https://confluence.ustack.com/pages/viewpage.action?pageId=6652628)

### 简介

  从Liberty版开始，Neutron数据库维护两个alembic分支：expand和contract分支。

- expand分支：该分支中的数据库迁移操作可以在Neutron Server运行状态中执行，因为该
分支的数据库升级对服务没有影响。这些操作包括：创建表，创建字段等等。
- contract分支：如果正在运行着Neutron Server，该分支的升级操作可能对服务有影响。
这些操作包括：字段、表的删除，数据的迁移。
总得来说，这两个分支的作用是为了Neutron Server的安全运行，减少升级服务时的停机时间。

### 升级过程
下面以增加一个新表为例介绍如何升级数据库。

1. 找到要升级的数据库模型文件，如db/models.py。添加如下代码：
```
class Test2(model_base.BASEV2, HasId):
    name = sa.Column(sa.String(attr.NAME_MAX_LEN))
```

2. 在db/migration目录下运行
```
neutron-db-manage --config-file /etc/neutron/neutron.conf \
--config-file /etc/neutron/plugins/ml2/ml2_conf.ini revision -m "test2" \
--autogenerate
输出：
Running revision for neutron ...
No handlers could be found for logger "neutron.quota"
INFO  [alembic.runtime.migration] Context impl MySQLImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.autogenerate.compare] Detected added table 'test2s'
Generating /opt/stack/neutron/neutron/db/migration/alembic_migrations/\
versions/mitaka/expand/10ce9ecdee7_test.py ... done
OK
```

  生成的 10ce9ecdee7_test.py文件内容如下：

   ```
   """test2
   Revision ID: 10ce9ecdee7
   Revises: d075320f3ca
   Create Date: 2015-10-12 16:33:28.800196
   """
   # revision identifiers, used by Alembic.
   revision = '10ce9ecdee7'
   down_revision = 'd075320f3ca'
   from alembic import op
   import sqlalchemy as sa
   def upgrade():
       ### commands auto generated by Alembic - please adjust! ###
       op.create_table('test2s',
       sa.Column('id', sa.String(length=36), nullable=False),
       sa.Column('name', sa.String(length=255), nullable=True),
       sa.PrimaryKeyConstraint('id'),
       mysql_engine='InnoDB'
       )
       ### end Alembic commands ###
```

3. 升级数据库到最新

   ```
使用命令：
neutron-db-manage --config-file /etc/neutron/neutron.conf \
--config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head
```

4. 查看数据库最新版本

   ```
neutron-db-manage --config-file /etc/neutron/neutron.conf \
--config-file /etc/neutron/plugins/ml2/ml2_conf.ini current
```
