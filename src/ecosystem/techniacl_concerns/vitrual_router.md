## 虚拟路由器实现

### 简介

#### UnitedStack 知识库相关文章

 - [Neutron Router 迁移理论分析、优化思路与实践](https://confluence.ustack.com/download/attachments/8752227/Neutron%20Router%20%E8%BF%81%E7%A7%BB%E7%90%86%E8%AE%BA%E5%88%86%E6%9E%90%E3%80%81%E4%BC%98%E5%8C%96%E6%80%9D%E8%B7%AF%E4%B8%8E%E5%AE%9E%E8%B7%B5.docx?version=1&modificationDate=1448294489623&api=v2)

#### 技术说明

 当虚拟机进行跨子网（东西向）和外网通信（南北向）通信时，需要走虚拟路由器或其他类似服务完成相关的路由和地址转换功能，本节不会讨论虚拟路由器上可能实现的高级功能。对于路由与地址转换，基本的实现思路有几种：
 
 - 集中式软件方案。例如 Neutron Classic 方案，特点是路由集中式，效率偏低，但代码比较成熟，目前外部 SDN 系统一般都会解决这个问题；
 - 集中式硬件方案。例如通过一个硬件路由器或其他设备实现路由和地址转换，得益于网络设备的高性能效果会比前者好；
 - 分布式软件方案。例如 Neutron DVR 方案、DragonFlow、OVN 等，特点是分布式，软件实现，故障域和性能都比较理想；
 - 分布式硬件方案。例如通过 Distributed Anycast Gateway（EVPN）、OpenFlow 等在 ToR 上实现路由功能，特点是分布式、硬件实现，故障域和性能都有很好的效果；
 - 分布式软硬件融合方案。例如通过 OpFlex 对 Open vSwitch 做控制，对于能在本机路由、地址转换的在服务器端实现，需要跨 ToR 的在 ToR 上实现，性能最好，但需要对服务器端做多改动。

 我们可以将涉及硬件的方案简单归纳如下：
 
 ![vxlan_l3_gw][1]
 
 当然其中是否使用 Border Leaf 来提供对外的连接，是否在计算节点内部尽量完成可完成的路由或 NAT 需要考虑具体的方案，这里只是基本的原理参考说明。

#### Anycast Gateway（EVPN）

 关于 EVPN VxLan 的详细说明参考 [架构－VxLan](../../architecture/vxlan.md)，这里简单说明 Anycast Gateway 的工作原理。



### 最佳实践

 一般认为分布式的路由实现会比集中式的实现架构更优异，但需要考虑具体场景和需求，例如集中式实现可以比较容易的管理、排错、人工修改配置，但分布式能够带来更小的故障域和更好的吞吐。而软硬融合的方案固然能带来最佳的架构和性能，但是需要看实现，目前的第三方实现可能需要在计算节点带来较多的修改，不利于排错和架构兼容性。
 
 
 [1]: ../../../images/ecosystem/l3_gw.png
 